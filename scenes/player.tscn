[gd_scene load_steps=8 format=3 uid="uid://demep833r44w5"]

[ext_resource type="Texture2D" uid="uid://bi5nluf0uq6r1" path="res://assets/Untitled Design Presentation (1).png" id="1_3vyb7"]

[sub_resource type="GDScript" id="GDScript_3vyb7"]
script/source = "extends CharacterBody2D

# --- Constants ---
const BASE_SPEED: float = 100.0
const BASE_JUMP: float = -600.0
const GRAVITY: float = 1400.0
const MAX_HOLD: float = 1.0
const MIN_SLIME: float = 0.05
const MAX_SLIME: float = 0.20
const MAX_SPEED_CAP: float = 600.0  # Absolute cap when small

# --- Exported Variables ---
@export var slime_size: float = 0.20
@export var chunk_scene: PackedScene

# --- Member Variables ---
var space_held_time: float = 0.0
var is_holding: bool = false
var current_visual_size: float = slime_size
var _player_orig_extents: Vector2 = Vector2.ZERO

# --- Node References ---
@onready var sprite: AnimatedSprite2D = $AnimatedSprite2D
@onready var player_collision: CollisionShape2D = $CollisionShape2D

# --- Initialization ---
func _ready() -> void:
	current_visual_size = slime_size
	sprite.scale = Vector2.ONE * current_visual_size

	if player_collision.shape is RectangleShape2D:
		_player_orig_extents = player_collision.shape.extents

	var root: Node = get_tree().current_scene
	for child in root.get_children():
		if child.has_method(\"spawn_at\"):
			child.queue_free()

# --- Physics Update ---
func _physics_process(delta: float) -> void:
	# Apply gravity
	if not is_on_floor():
		velocity.y += GRAVITY * delta
	else:
		velocity.y = 0.0

	# Dynamic speed: smaller = faster
	var min_speed: float = 160.0
	var max_speed: float = 800.0
	var speed: float = remap(current_visual_size, MIN_SLIME, MAX_SLIME, max_speed, min_speed)
	speed = min(speed, MAX_SPEED_CAP)

	var input_dir: float = Input.get_axis(\"ui_left\", \"ui_right\")
	velocity.x = input_dir * speed

	# Flip sprite based on direction
	if velocity.x != 0:
		sprite.flip_h = velocity.x < 0

	# Adjusted jump scaling: smaller slime jumps less high
	var min_jump: float = -200.0  # Previously -300.0
	var max_jump: float = -650.0  # Previously -800.0
	var jump_velocity: float = remap(current_visual_size, MIN_SLIME, MAX_SLIME, min_jump, max_jump)

	if Input.is_action_just_pressed(\"ui_up\") and is_on_floor():
		velocity.y = jump_velocity

	move_and_slide()
	_update_player_collision()

# --- Non-physics Update ---
func _process(delta: float) -> void:
	if Input.is_action_just_pressed(\"split_slime\"):
		is_holding = true
		space_held_time = 0.0

	if is_holding:
		space_held_time += delta
		var hold_frac: float = clamp(space_held_time / MAX_HOLD, 0.0, 1.0)
		var shrink_scale: float = max(current_visual_size * (1.0 - 0.5 * hold_frac), MIN_SLIME)
		sprite.scale = Vector2.ONE * shrink_scale

	if Input.is_action_just_released(\"split_slime\") and is_holding:
		is_holding = false
		var final_frac: float = clamp(space_held_time / MAX_HOLD, 0.0, 1.0)
		var shrink_scale: float = max(current_visual_size * (1.0 - 0.5 * final_frac), MIN_SLIME)

		# Update visual size BEFORE performing split
		current_visual_size = shrink_scale
		sprite.scale = Vector2.ONE * current_visual_size

		_perform_split_and_spawn(final_frac)
		space_held_time = 0.0

# --- Perform Split ---
func _perform_split_and_spawn(fraction: float) -> void:
	if chunk_scene == null:
		return

	if fraction <= 0.02:
		return

	var split_amount: float = slime_size * fraction
	var remaining: float = slime_size - split_amount
	if remaining < MIN_SLIME:
		return

	var chunk: Node = chunk_scene.instantiate()
	var root: Node = get_tree().current_scene
	root.add_child(chunk)

	if chunk.has_method(\"spawn_at\"):
		chunk.spawn_at(global_position, split_amount)

	slime_size = remaining
	_update_player_collision()

# --- Collision Shape Resizer ---
func _update_player_collision() -> void:
	if player_collision.shape is RectangleShape2D:
		player_collision.shape.extents = _player_orig_extents * current_visual_size
"

[sub_resource type="AtlasTexture" id="AtlasTexture_g2els"]
atlas = ExtResource("1_3vyb7")
region = Rect2(35, 256, 164, 128)

[sub_resource type="AtlasTexture" id="AtlasTexture_qhqgy"]
atlas = ExtResource("1_3vyb7")
region = Rect2(199, 256, 164, 128)

[sub_resource type="AtlasTexture" id="AtlasTexture_dqkch"]
atlas = ExtResource("1_3vyb7")
region = Rect2(363, 256, 164, 128)

[sub_resource type="SpriteFrames" id="SpriteFrames_g2els"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_g2els")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qhqgy")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_dqkch")
}],
"loop": true,
"name": &"default",
"speed": 3.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_3vyb7"]
size = Vector2(102, 75)

[node name="Player" type="CharacterBody2D"]
script = SubResource("GDScript_3vyb7")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
sprite_frames = SubResource("SpriteFrames_g2els")
autoplay = "default"

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(-6, -2.5)
shape = SubResource("RectangleShape2D_3vyb7")
